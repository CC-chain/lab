---
- name: Ensure external-secrets namespace exists
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: external-secrets
    state: present
    kubeconfig: "{{ k8s_kubeconfig_user | default('/home/ubuntu/.kube/config') }}"
  tags: ['k8s_secrets', 'k8s_all']

- name: Ensure external-secrets Helm repo exists
  ansible.builtin.command:
    cmd: helm repo add external-secrets https://charts.external-secrets.io
  register: k8s_secrets_prom_repo_add
  failed_when: >
    k8s_secrets_prom_repo_add.rc != 0 and
    ('exists' not in k8s_secrets_prom_repo_add.stderr | lower)
  changed_when: >
    k8s_secrets_prom_repo_add.rc == 0 and
    ('has been added' in k8s_secrets_prom_repo_add.stdout | lower)
  tags: ['k8s_secrets', 'k8s_all']

- name: Update Helm repositories
  ansible.builtin.command:
    cmd: helm repo update
  changed_when: false
  tags: ['k8s_secrets', 'k8s_all']

- name: Install External Secrets Operator via Helm
  kubernetes.core.helm:
    name: external-secrets
    chart_ref: external-secrets/external-secrets
    release_namespace: external-secrets
    create_namespace: false
    state: present
    kubeconfig: "{{ k8s_kubeconfig_user | default('/home/ubuntu/.kube/config') }}"
    values:
      installCRDs: true
  tags: ['k8s_secrets', 'k8s_all']

- name: Ensure hashicorp Helm repo exists
  ansible.builtin.command:
    cmd: helm repo add hashicorp https://helm.releases.hashicorp.com
  register: k8s_secrets_hashicorp_repo_add
  failed_when: >
    k8s_secrets_hashicorp_repo_add.rc != 0 and
    ('exists' not in k8s_secrets_hashicorp_repo_add.stderr | lower)
  changed_when: >
    k8s_secrets_hashicorp_repo_add.rc == 0 and
    ('has been added' in k8s_secrets_hashicorp_repo_add.stdout | lower)
  tags: ['k8s_secrets', 'k8s_all']

- name: Update Helm repositories
  ansible.builtin.command:
    cmd: helm repo update
  changed_when: false
  tags: ['k8s_secrets', 'k8s_all']

- name: Ensure vault namespace exists
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: vault
    state: present
    kubeconfig: "{{ k8s_kubeconfig_user | default('/home/ubuntu/.kube/config') }}"
  tags: ['k8s_secrets', 'k8s_all']

- name: Install/upgrade Vault via Helm (dev mode)
  kubernetes.core.helm:
    name: vault
    chart_ref: hashicorp/vault
    release_namespace: vault
    create_namespace: false
    state: present
    kubeconfig: "{{ k8s_kubeconfig_user }}"
    values:
      server:
        dev:
          enabled: true
  tags: ['k8s_secrets', 'k8s_all']

- name: Ensure Vault token secret exists for ESO
  kubernetes.core.k8s:
    kubeconfig: "{{ k8s_kubeconfig_user }}"
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: vault-token
        namespace: external-secrets
      type: Opaque
      data:
        token: "cm9vdA=="
  tags: ['k8s_secrets', 'k8s_all']

- name: Wait for ClusterSecretStore CRD to exist
  kubernetes.core.k8s_info:
    api_version: apiextensions.k8s.io/v1
    kind: CustomResourceDefinition
    name: clustersecretstores.external-secrets.io
    kubeconfig: "{{ k8s_kubeconfig_user }}"
  register: k8s_secrets_css_crd
  until: k8s_secrets_css_crd.resources | length > 0
  retries: 20
  delay: 6
  tags: ['k8s_secrets', 'k8s_all']

- name: Apply ClusterSecretStore manifest
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('file', role_path + '/files/clustersecretstore.yaml') | from_yaml }}"
    kubeconfig: "{{ k8s_kubeconfig_user }}"
  tags: ['k8s_secrets', 'k8s_all']

